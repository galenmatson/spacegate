# Antiproton Runtime Environment

This document captures the current public deployment layout for `spacegates.org` on `antiproton`.

## Host + DNS

- Host: `antiproton`
- Public domain: `spacegates.org` / `www.spacegates.org`
- Public IP (as of 2026-02-18): `158.69.159.29`

## Filesystem Layout

- Repo checkout: `/srv/spacegate/app`
- Runtime data root: `/srv/spacegate/data`
- Public download artifacts: `/srv/spacegate/dl`
- Published archive directory: `/srv/spacegate/dl/db`
- Current archive symlink: `/srv/spacegate/dl/current -> db/<build>.7z`
- Current metadata: `/srv/spacegate/dl/current.json`

## Runtime Mode

- Services run with Docker Compose from `/srv/spacegate/app/docker-compose.yml`.
- Container ports are loopback-only:
- API: `127.0.0.1:8000 -> container:8000`
- Web: `127.0.0.1:8081 -> container:80`
- Public traffic is served by host nginx on `80/443`.

## Data Bootstrap

- Bootstrap source metadata: `https://spacegates.org/dl/current.json` (or local `file:///srv/spacegate/dl/current.json`).
- Bootstrap script:
  - `scripts/bootstrap_core_db.sh`
- Promoted build target:
  - `/srv/spacegate/data/served/current -> ../out/<build_id>`

Recommended bootstrap command on antiproton:

```bash
cd /srv/spacegate/app
SPACEGATE_STATE_DIR=/srv/spacegate/data \
SPACEGATE_CACHE_DIR=/srv/spacegate/data/cache \
scripts/bootstrap_core_db.sh \
  --meta-url file:///srv/spacegate/dl/current.json \
  --base-url file:///srv/spacegate/dl/
```

## Container Runtime Env

Recommended runtime values for antiproton (12 GB RAM class host):

```bash
cd /srv/spacegate/app
SPACEGATE_DATA_DIR=/srv/spacegate/data \
SPACEGATE_API_DUCKDB_MEMORY_LIMIT=6GB \
SPACEGATE_API_DUCKDB_THREADS=3 \
docker compose up -d --build
```

## Nginx

- Managed config path: `/etc/nginx/sites-available/spacegate.conf`
- Generated by: `scripts/setup_nginx_spacegate.sh`
- Mode: container web proxy (`/ -> http://127.0.0.1:8081`, `/api/ -> http://127.0.0.1:8000`)
- `/dl/` served from `/srv/spacegate/dl/`

Recommended apply command:

```bash
cd /srv/spacegate/app
sudo SPACEGATE_SERVER_NAME="spacegates.org www.spacegates.org" \
  SPACEGATE_TLS_ENABLE=1 \
  SPACEGATE_TLS_CERT_FILE=/etc/letsencrypt/live/spacegates.org/fullchain.pem \
  SPACEGATE_TLS_KEY_FILE=/etc/letsencrypt/live/spacegates.org/privkey.pem \
  scripts/setup_nginx_spacegate.sh --force --container-web
```

## Fail2ban

Configured jails:

- `sshd`
- `nginx-spacegate-probe`
- `recidive`

Config files:

- `/etc/fail2ban/jail.d/spacegate-nginx.local`
- `/etc/fail2ban/filter.d/nginx-spacegate-probe.conf`

## Operational Checks

Use these for at-a-glance validation:

```bash
cd /srv/spacegate/app
scripts/spacegate_status.sh --public-url https://spacegates.org
scripts/ops_report.sh --public-url https://spacegates.org
docker compose ps
curl -fsS https://spacegates.org/api/v1/health
sudo fail2ban-client status
```

## Backups (Minimum)

Back up:

- `/srv/spacegate/data`
- `/srv/spacegate/dl`
- `/etc/nginx/sites-available/spacegate.conf`
- `/etc/fail2ban/jail.d/spacegate-nginx.local`
- `/etc/fail2ban/filter.d/nginx-spacegate-probe.conf`

## Keep This Findable On Host

Copy this file onto the host root deploy directory:

```bash
cd /srv/spacegate/app
cp docs/ANTIPROTON_RUNTIME.md /srv/spacegate/RUNTIME.md
```
